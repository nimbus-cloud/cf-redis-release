#!/bin/bash -e

BACKUP_DIR=/var/vcap/services_backup/backups/cf-redis
TIME=`/bin/date +"%Y-%m-%d-%H"`
Mountpoint=/var/vcap/services_backup

nfs_server=<%= p("redis.broker.nfs_server") %>
nfs_directory=<%= p("redis.broker.nfs_directory") %>

/bin/mkdir -p ${Mountpoint}

if /bin/mountpoint -q "$Mountpoint" ; then
    echo "NFS file mounted"
else
    /bin/mount -t nfs $nfs_server:$nfs_directory $Mountpoint
    /bin/echo "Mounted the NFS share."
fi

for a in `/bin/ls -l /var/vcap/store/cf-redis-broker/redis-data/ | /bin/grep ^d | /usr/bin/awk '{print $9}'`
    do
        /bin/mkdir -p ${BACKUP_DIR}/${a}/${TIME}
        /bin/cp -p /var/vcap/store/cf-redis-broker/redis-data/${a}/db/dump.rdb ${BACKUP_DIR}/${a}/${TIME}/
        /bin/cp -p /var/vcap/store/cf-redis-broker/redis-data/${a}/redis.conf ${BACKUP_DIR}/${a}/${TIME}/

        /usr/bin/find ${BACKUP_DIR}/${a} -type f -mtime +14 -delete
    done